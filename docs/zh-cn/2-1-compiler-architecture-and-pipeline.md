# 编译器架构与流水线

## 整体架构

Dovetail 编译器采用多阶段编译架构，确保代码的正确性和性能：

```源代码(.mcdl) → 词法分析 → 语法分析 → AST → 语义分析 → IR生成 → 优化 → 代码生成 → 数据包```

## 核心组件

### 1. 前端处理器

**位置**: `main.py`、`transpiler/core/parser/`

负责处理源代码的解析和预处理：

- **词法分析**: 将源代码转换为 token 流
- **语法分析**: 使用 ANTLR4 语法规则构建 AST

### 2. 语义分析器 & IR 生成器

**位置**: `transpiler/core/ir_generator.py`

核心类 `IRGenerator` 负责：

- **符号解析**: 构建符号表，解析变量、函数、类等定义
- **类型检查**: 验证类型兼容性和转换
- **作用域管理**: 处理嵌套作用域和变量可见性
- **递归检测**: 检测并报告不支持的递归调用
- **IR生成**: 将 AST 转换为中间表示

### 3. IR 优化

**位置**: `transpiler/core/optimize/optimizer.py`

核心类 `Optimizer` 负责：

- **管理管道**: 管理与选择优化管道
- **优化收敛**: 通过计算哈希优化到 ir 收敛

### 4. 后端

继承于类 `Backend`
通过插件扩展，将`IR`生成为最终数据包