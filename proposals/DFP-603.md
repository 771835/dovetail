# DFP 603: 编译缓存与增量编译

## 提案信息

**作者**: 771835 2790834181@qq.com  
**状态**: Draft  
**创建日期**: 2026-02-03  
**最新更新**: 2026-02-03

## 设计目标

本提案旨在为 Dovetail 编译器引入编译缓存和增量编译能力，通过缓存 IR 和符号表信息，避免重复编译未修改的文件，显著提升大型项目的编译速度。

## 动机

### 问题背景

1. 全量重新编译  
   当前每次编译都从头开始解析、生成 IR、优化，即使只修改了一个文件。

2. 大型项目编译慢  
   包含多个 include 文件的项目，每次编译都需要重新处理所有依赖。

3. 已有临时文件未充分利用  
   代码中有 --output-temp-file 选项生成缓存文件，但未用于增量编译。

4. 开发体验差  
   频繁修改代码时，编译等待时间累积明显。

### 需求分析

- 开发者需求：快速验证代码修改效果
- 大型项目需求：支持模块化编译

## 技术规范

1. 缓存粒度  
   **文件级缓存：**

    - 每个 `.mcdl` 源文件对应一个缓存文件
    - 缓存内容包括：
    - AST（可选，体积较大）
    - IR 指令序列
    - 符号表
    - 文件哈希值（用于检测修改）
      缓存文件命名： `./.dovetail_cache/file.mcdl`
2. 缓存失效机制  
   **触发重新编译的条件：**
    - 源文件内容变化（通过 SHA256 哈希检测或修改时间对比）
    - 依赖文件变化（通过依赖图追踪）
    - 编译选项变化（优化级别、目标版本等）
    - 编译器版本变化
    - 用户显式清除缓存（`--clean`）

   **依赖追踪：**
    - 记录每个文件的 include 依赖关系
    - 构建依赖图，级联失效
3. 缓存数据结构  
   **缓存元数据：**

    ```json
    {
      "version": "1.0",
      "compiler_version": "dev20260202",
      "source_hash": "sha256:...",
      "compile_config": {
        "optimization_level": 2,
        "minecraft_version": "1.20.4"
      },
      "dependencies": [
        {
          "path": "lib/std.mcdl",
          "hash": "sha256:..."
        }
      ],
      "timestamp": "2026-02-02T14:30:25"
    }
    ```
4. 增量编译流程

   ```markdown
   1. 解析项目依赖图
   2. 对每个源文件：
      1. 计算文件哈希
      2. 检查缓存是否存在且有效
      3. 如果有效，加载缓存的 IR
      4. 如果无效，重新编译并更新缓存
   3. 合并所有模块的 IR
   4. 执行全局优化
   5. 生成最终代码
   ```

## 变更日志

- 2026-02-03：初始提案创建