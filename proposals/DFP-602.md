## DFP 602: 插件系统规范

### 提案信息

**作者**: 771835 <2790834181@qq.com>  
**状态**: Draft  
**创建日期**: 2026-02-03  
**最新更新**: 2026-02-03

---

### 摘要

本提案定义了 Dovetail 编译器的插件系统架构，规范插件类型、元数据格式、生命周期管理、注册机制和插件间通信，为编译器的扩展能力提供稳定、可维护的基础设施。

---

### 动机

#### 问题背景

Dovetail 编译器需要支持多种后端（如 Minecraft 不同版本的指令生成）、优化 Pass、标准库扩展等。现有插件系统（v1
API）虽可运作，但存在以下问题：

1. **插件类型划分不清晰**  
   后端、优化 Pass、库、加载器等不同类型的插件混杂在同一框架下，缺乏明确的类型约束和生命周期差异。

2. **元数据规范松散**  
   缺少必需的兼容性声明、依赖版本约束、API 版本要求等关键信息。

3. **加载顺序无保障**  
   插件间的依赖关系和加载顺序无法显式控制，可能导致初始化顺序错误。

4. **隔离机制不完善**  
   插件共享全局命名空间，可能相互污染；缺乏资源隔离和错误边界。

#### 需求分析

- **编译器核心**：需要标准化的注册机制（后端、优化 Pass、库）
- **插件开发者**：需要清晰的开发文档、类型约束和调试支持
- **普通用户**：需要简单的插件管理（加载、启用/禁用、版本检查）

---

### 技术规范

#### 1. 插件分类

插件按功能分为以下类型：

| 类型    | 标识符       | 用途                  | 注册目标 |
|-------|-----------|---------------------|------|
| 标准库   | `library` | 内置函数、类型扩展           | 库映射表 |
| 插件加载器 | `loader`  | 扩展插件加载能力            | 加载器链 |
| 普通插件  | `plugin`  | 注册基本插件，用于注册后端、优化管道等 | -    |

#### 2. 插件元数据规范

**必需字段**：

| 字段                | 类型     | 说明                      |
|-------------------|--------|-------------------------|
| `display_name`    | string | 插件显示名称                  |
| `plugin_id`       | string | 唯一标识符，建议反向域名格式          |
| `plugin_version`  | string | 语义化版本号（如 `1.0.0`）       |
| `plugin_type`     | enum   | 插件类型（见上文分类）             |
| `main_class`      | string | 入口类名                    |
| `plugin_main`     | string | 主文件路径（相对于插件目录）          |
| `min_api_version` | string | 最低支持的 API 版本（如 `1.0.0`） |

**可选字段**：

| 字段              | 类型     | 说明                |
|-----------------|--------|-------------------|
| `plugin_author` | array  | 作者列表              |
| `description`   | string | 插件描述              |
| `dependencies`  | object | 依赖插件及版本约束         |
| `conflicts`     | array  | 冲突插件列表            |
| `compatibility` | object | Minecraft 版本兼容性声明 |

**元数据示例**：

```json
{
  "display_name": "JE 1.20.4 后端",
  "plugin_id": "org.dovetail.backends.je1204",
  "plugin_version": "1.0.0",
  "plugin_type": "backend",
  "main_class": "JE1204",
  "plugin_main": "main.py",
  "min_api_version": "1.0.0",
  "plugin_author": [
    "771835"
  ],
  "description": "Java Edition 1.20.4 命令生成后端",
  "dependencies": {
    "org.dovetail.libraries.core": ">=1.0.0"
  },
  "compatibility": {
    "minecraft": [
      "1.20.4"
    ]
  }
}
```

#### 3. 插件生命周期

插件生命周期包含以下阶段：

```
[发现] → [验证] → [初始化] → [加载] → [激活] → [运行] → [卸载]
              ↓                                    ↓
           [失败]                               [失败]
```

| 阶段  | 触发时机      | 插件方法              | 失败处理       |
|-----|-----------|-------------------|------------|
| 发现  | 扫描插件目录    | -                 | 忽略该插件      |
| 验证  | 加载前       | `validate()`      | 拒绝加载，输出错误  |
| 初始化 | 验证通过后     | `initialize()`    | 标记为失败，跳过加载 |
| 加载  | 初始化成功后    | `load()`          | 回滚已注册资源    |
| 激活  | 所有依赖满足    | `activate()` （可选） | 降级为非激活状态   |
| 运行  | 编译过程中     | 业务逻辑（如代码生成）       | 捕获异常，标记为错误 |
| 卸载  | 插件显式卸载或退出 | `unload()`        | 强制清理，输出警告  |

#### 4. 注册机制

插件通过统一的注册接口扩展编译器功能：

**后端注册**：

- 插件实现具体后端接口
- 通过 `registry_backend()` 注册

**优化 Pass 注册**：

- 插件实现具体优化管道接口
- 通过 `registry_optimization_pass(optimization_pass,)` 注册
- 关联到指定的优化级别（O0-O3）

**库注册**：

- 插件实现 `Library` 接口
- 通过 `registry_library(library_name, library)` 注册
- 库名需全局唯一

#### 5. 插件间通信

插件间通过消息系统进行松耦合通信：

**消息发送**：

```python
plugin.send_message(target_plugin_id, message_data)
```

**消息处理**：

```python
def handle_message(self, sender: Plugin, message: Any) -> Any:
    # 处理消息，可选择返回响应
    pass
```

**通信规范**：

- 消息格式建议使用字典或可序列化对象
- 发送方应检查接收方是否存在
- 接收方应验证消息合法性
- 避免循环消息导致死锁

#### 6. 依赖与冲突管理

**依赖解析规则**：

1. **版本约束**  
   支持语义化版本约束（`^1.0.0`、`>=2.0.0`、`~1.2.3`）

2. **加载顺序**  
   依赖的插件先加载，形成拓扑排序

3. **循环依赖检测**  
   检测到循环依赖时拒绝加载所有相关插件

**冲突处理**：

- 声明冲突的插件不能同时加载
- 冲突时优先加载用户显式指定的插件

#### 7. 插件隔离与安全

**命名空间隔离**：

- 每个插件在独立的模块命名空间中执行
- 插件通过注册接口与核心交互，避免直接修改全局状态

**错误边界**：

- 插件加载失败不应影响其他插件
- 插件运行时异常应被捕获，不影响编译器稳定性

**资源管理**：

- 插件应实现 `unload()` 释放资源
- 编译器在退出时强制卸载所有插件

#### 8. API 版本管理

**API 版本号**：语义化版本号（主.次.补丁）

- **主版本号**：不兼容的 API 变更
- **次版本号**：向后兼容的功能新增
- **补丁号**：向后兼容的错误修复

**兼容性检查**：

- 插件声明 `min_api_version` 和 `max_api_version`（可选）
- 编译器检查自身 API 版本是否在插件要求范围内

**迁移策略**：

- 主版本升级时提供过渡期，支持旧 API 至少一个版本(架构变更较大，继续支持困难/无法继续支持的情况下除外)
- 提供废弃警告，标记将在未来版本移除的功能

### 变更日志

- **2026-02-03**：初始提案创建
