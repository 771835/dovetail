## DFP 8: 命名归一化策略

### 提案信息

**作者**: 771835 <2790834181@qq.com>  
**状态**: Active  
**创建日期**: 2026-02-03  
**最新更新**: 2026-02-03

---

### 设计目标

规范 Dovetail 语言中标识符到 Minecraft 数据包函数名的转换规则，解决编程命名习惯与 Minecraft
命名限制之间的冲突。通过可逆的归一化算法，允许开发者使用符合编程习惯的命名风格，同时确保生成的函数名符合目标平台规范。

---

### 动机

#### 问题背景

**命名约定的矛盾**

- 现代编程语言普遍使用 `camelCase`、`PascalCase` 等命名风格
- Minecraft 数据包函数名仅允许：小写字母、数字、下划线、斜杠
- 这种限制迫使开发者在代码可读性和平台兼容性之间做出妥协

**跨文化支持需求**

- 开发者可能希望使用非 ASCII 字符（如中文函数名）
- 目标平台对这些字符的支持有限或不一致

**已有代码迁移困难**

- 从其他语言移植的代码通常使用特定命名风格
- 强制修改所有命名会增加迁移成本

#### 需求分析

1. **可逆性**：必须能从转换后的名称恢复原始名称
2. **安全性**：转换结果必须符合目标平台规范
3. **可读性**：转换后的名称应尽可能保持可读
4. **可配置性**：允许项目选择是否启用此功能
5. **冲突检测**：避免不同原始名称转换为相同结果

---

### 技术规范

#### 1. 归一化转换规则

定义以下转换策略：

| 字符类型       | 转换规则                    | 目的               |
|------------|-------------------------|------------------|
| 大写字母 (A-Z) | 前缀 `_` + 小写形式           | 保留大小写信息          |
| 下划线 (`_`)  | 双倍化为 `__`               | 区分原始下划线和转换产生的下划线 |
| 小写字母 (a-z) | 保持不变                    | 直接兼容             |
| 数字 (0-9)   | 保持不变                    | 直接兼容             |
| 非 ASCII 字符 | 编码为 `___<Unicode码点>___` | 安全保存特殊字符         |
| 其他符号       | 编码为 `___<ASCII码>___`    | 保证完全兼容           |

**转换示例**：

```
MyFunction       → _my_function
calculateDamage  → calculate_damage
old_style        → old__style
get价格          → get___20215______26684___
```

#### 2. 反归一化规则

逆向恢复过程应遵循以下优先级：

1. **识别编码模式**：`___数字___` → 对应 Unicode/ASCII 字符
2. **识别下划线转义**：`__` → 单个 `_`
3. **识别大小写标记**：`_小写字母` → 大写字母
4. **其他字符**：保持不变

该过程必须满足：`denormalize(normalize(x)) == x`

#### 3. 全局控制机制

**默认行为**：

- 归一化功能默认**启用**
- 适用于所有用户定义的标识符

**禁用选项**：

- 提供命令行参数禁用功能
- 禁用后直接使用原始标识符，不进行转换
- 开发者需自行确保命名符合目标平台规范

#### 4. 作用范围

**需要归一化的标识符**：

- 函数名、方法名
- 类名、接口名
- 全局变量名（如需生成外部可见符号）

**不进行归一化的内容**：

- 字符串字面量中的内容
- 注释和文档
- 文件系统路径
- 命名空间标识符（应直接遵守 Minecraft 规范）
- 编译器内部临时变量（如果已确保合规）

#### 5. 冲突检测与处理

**冲突定义**：
两个不同的原始标识符归一化后产生相同结果。

**示例冲突**：

```
myFunction  → my__function
my_function → my__function  (冲突！)
```

**处理策略**：

- 编译器必须在符号解析阶段检测此类冲突
- 检测到冲突时报告编译错误
- 错误信息应指出冲突的原始标识符及其位置
- **不**自动解决冲突（避免隐式行为）

#### 6. 长度限制

**约束条件**：

- Minecraft 函数路径总长度限制为 2000000 字符
- 归一化可能显著增加标识符长度（特殊字符编码）

**处理策略**：

- 编译器应验证归一化后的长度
- 超出限制时报告编译错误
- 错误信息应建议使用更短的标识符

**可选方案**：

- 自动生成哈希后缀截断
- 提供名称压缩选项

---

### 设计原则

#### 可逆性优先

所有转换必须完全可逆，以支持：

- 调试时显示原始名称
- 错误信息中使用原始名称
- 可能的反编译工具

#### 最小惊讶原则

- 常见命名风格（如 `camelCase`）转换结果应直观
- 避免引入难以理解的特殊规则
- 转换规则应文档化并易于推导

#### 明确优于隐式

- 冲突时报错而非自动重命名
- 超长时报错而非自动截断
- 提供禁用选项而非强制使用

---

### 兼容性影响

#### 对现有代码的影响

**启用归一化**：

- 使用 `snake_case` 的代码仍然兼容（下划线会被转义为 `__`）
- 使用其他风格的代码可正常编译
- 生成的数据包函数名会发生变化

**禁用归一化**：

- 恢复原始行为

#### 数据包版本兼容性

**重要警告**：

- 改变归一化设置会导致生成的函数名不同
- 不同设置编译的数据包**不兼容**
- 建议在项目配置文件中显式声明归一化策略

#### 工具链影响

- IDE 和语言服务器需要支持名称转换
- 调试工具应显示原始名称而非归一化后的名称
- 文档生成工具应使用原始命名

---

### 未来扩展方向

#### 1. 名称压缩

为减小数据包体积提供短名称生成：

- 可选的混淆模式（类似 JavaScript minifier）
- 保留调试符号映射
- 仅在发布构建时启用

#### 2. 智能冲突解决

在根据命令行参数下自动解决冲突：

- 添加最小差异后缀（如 `_1`, `_2`）
- 提供交互式选择
- 生成冲突报告供审查

#### 4. 增强的 Unicode 支持

优化非 ASCII 字符的编码：

- 为常用 CJK 字符设计更短的编码
- 支持 UTF-8 安全的直接传递（如果目标平台支持）
- 可配置的字符集白名单

### 参考

**相关规范**：

- Minecraft Wiki
- RFC 3986（URI 编码）
- Unicode 标准

### 变更日志

- **2026-02-03**：初始提案创建，规范化现有实现的设计决策