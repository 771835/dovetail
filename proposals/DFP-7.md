# DFP 7: 错误恢复机制

## 提案信息

**作者**: 771835 2790834181@qq.com  
**状态**: Draft  
**创建日期**: 2026-02-03  
**最新更新**: 2026-02-03

## 设计目标

本提案旨在为 Dovetail 编译器引入错误恢复机制，使编译器在遇到错误时能够继续分析代码，一次性报告多个错误，提升开发体验。

## 动机

### 问题背景

当前编译器采用"遇到第一个错误即终止"的策略：

1. 开发效率低下  
   用户修复一个错误后重新编译，才能发现下一个错误。对于大型文件，这个循环极其低效。

2. 错误定位困难  
   单一错误可能引发连锁反应，后续的"假错误"混淆了真正的问题根源。

3. IDE 集成不友好  
   语言服务器无法提供实时的多错误诊断，影响编辑器体验。

### 需求分析

- 编译器需求：在错误状态下继续解析，生成尽可能完整的 AST
- 性能需求：错误恢复不应显著增加编译时间

## 技术规范

1. 错误分类
   将错误分为三类，采取不同的恢复策略：

| 错误类型 | 恢复策略         | 示例           |
|------|--------------|--------------|
| 语法错误 | 	跳过到下一个有效语句  | 	缺少分号、括号不匹配  |
| 语义错误 | 	插入占位符符号继续分析 | 	未定义变量、类型不匹配 |
| 致命错误 | 	立即终止编译      | 	文件不存在、内存不足  |

2. 恢复点定义  
   **语法层面的恢复点：**

    - 语句边界：;、}、关键字 func/class/if 等
    - 块结束：函数体结束、类定义结束
    - 顶层声明：遇到下一个全局声明时恢复

   **语义层面的恢复策略：**

    - 未定义符号：插入错误类型占位符，继续类型检查
    - 类型不匹配：假定类型转换成功，记录错误但继续
    - 作用域错误：使用最近的有效作用域

## 兼容性影响

错误恢复是**可选**功能，通过 `--continue-on-error` 启用  
默认行为保持"遇错即停"，向后兼容

## 变更日志

- 2026-02-03：初始提案创建